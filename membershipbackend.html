<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Membership Backend</title>
</head>
<body>

<h1>Membership Backend</h1>

<div>
    <h2>Total Amount Spent: $<span id="amount_spent"></span></h2>
    <button onclick="editAmount()">Edit</button>
    <button onclick="deleteAmount()">Delete</button>
</div>

<div>
    <h2>Generated Promo Codes:</h2>
    <div id="promo_codes"></div>
</div>

<!-- Include jQuery -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<!-- Script to update the total amount spent dynamically -->
<script>
    $(document).ready(function () {
        // Fetch and display the amount spent and promo codes on page load
        fetchAmountSpentAndPromoCodes();

        function fetchAmountSpentAndPromoCodes() {
            // Fetch amount spent
            $.ajax({
                type: "GET",
                url: "/get_amount_spent",
                success: function (data) {
                    $("#amount_spent").text(data.amount_spent);
                },
                error: function (xhr, status, error) {
                    console.log("An error occurred while fetching the amount spent:", error);
                }
            });

            // Fetch promo codes
            $.ajax({
                type: "GET",
                url: "/get_promo_codes",
                success: function (data) {
                    // Display promo codes in a list with delete buttons
                    var promoCodesList = data.promo_codes.map(code => `<li>${code} <button class="delete-btn" data-code="${code}" onclick="deletePromoCode('${code}')">Delete</button></li>`).join('');
                    $("#promo_codes").html(`<ul>${promoCodesList}</ul>`);
                },
                error: function (xhr, status, error) {
                    console.log("An error occurred while fetching promo codes:", error);
                }
            });
        }

        // Set interval to periodically fetch and update the amount spent and promo codes
        setInterval(fetchAmountSpentAndPromoCodes, 5000);  // Adjust the interval as needed

        // Handle edit button click for amount spent
        window.editAmount = function () {
    var newAmount = prompt("Enter the new amount:");

    if (newAmount !== null && !isNaN(newAmount) && parseFloat(newAmount) > -1) {
        $.ajax({
            type: "POST",
            url: "/edit_amount_spent",
            data: { amount_spent: newAmount },
            success: function (response) {
                if (response.success) {
                    alert("Amount updated successfully!");
                    fetchAmountSpentAndPromoCodes(); // Refresh the displayed amount and promo codes
                } else {
                    alert("Failed to update amount: " + response.error);
                }
            },
            error: function (xhr, status, error) {
                alert("An error occurred while updating the amount: " + error);
            }
        });
    } else {
        alert("Please enter a positive number");
    }
};

        // Handle delete button click for amount spent with confirmation alert
        window.deleteAmount = function () {
            var confirmDelete = confirm("Are you sure you want to delete this amount?");
            if (confirmDelete) {
                $.ajax({
                    type: "POST",
                    url: "/reset_amount_spent",
                    success: function (response) {
                        if (response.success) {
                            alert("Amount deleted successfully!");
                            fetchAmountSpentAndPromoCodes(); // Refresh the displayed amount and promo codes
                        } else {
                            alert("Failed to delete amount: " + response.error);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert("An error occurred while deleting the amount: " + error);
                    }
                });
            }
        };

        // Function to handle the click event for deleting promo codes
        window.deletePromoCode = function (code) {
            var confirmDelete = confirm("Are you sure you want to delete this promo code?");
            if (confirmDelete) {
                $.ajax({
                    type: "POST",
                    url: "/delete_promo_code",
                    data: { promo_code: code },
                    success: function (response) {
                        if (response.success) {
                            alert("Promo code deleted successfully!");
                            fetchAmountSpentAndPromoCodes(); // Refresh the displayed promo codes
                        } else {
                            alert("Failed to delete promo code: " + response.error);
                        }
                    },
                    error: function (xhr, status, error) {
                        alert("An error occurred while deleting the promo code: " + error);
                    }
                });
            }
        };
    });
</script>

</body>
</html>
